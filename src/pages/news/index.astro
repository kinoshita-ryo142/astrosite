---
import Header from '../../components/Header.astro';
import Newslist from '../../components/Newslist.astro';
import Footer from '../../components/Footer.astro';
import Layout from '../../layouts/Layout.astro';
import Marquee from '../../components/Marquee.astro';
import { getCategories } from '../../lib/microcms';

const categories = (await getCategories()) ?? [];
const url = new URL(Astro.request.url);
const selectedCategory = url.searchParams.get('category') ?? '';
---
<script type="text/javascript">(function(){
  const getSelected = ()=> new URL(location.href).searchParams.get('category') || '';
  function filter(category){
    const articles = document.querySelectorAll('#main_area article[data-categories]');
    articles.forEach(a=>{
      const cats = (a.getAttribute('data-categories')||'').split(',').filter(Boolean);
      if(!category || cats.includes(category)) a.classList.remove('hidden'); else a.classList.add('hidden');
    });
    document.querySelectorAll('ul.mb-6 a[data-cat]').forEach(a=>{
      a.classList.remove('font-bold');
      a.classList.add('underline', 'text-gray-900');
    });
    // add bold to the current selection and remove underline
    const current = document.querySelector(`ul.mb-6 a[data-cat="${getSelected()}"]`);
    if(current){
      current.classList.add('font-bold');
      current.classList.remove('underline');
    }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    filter(getSelected());
    document.querySelectorAll('ul.mb-6 a[data-cat]').forEach(a=>{
      a.addEventListener('click', e=>{
        e.preventDefault();
        const cat = a.dataset.cat || '';
        history.pushState({}, '', cat ? `/news?category=${cat}` : '/news');
        filter(cat);
      });
    });
    window.addEventListener('popstate', ()=> filter(getSelected()));
  });
})();</script>

<Layout>
    <div class="relative min-h-screen">
      <div class="relative lg:fixed top-0 left-0 w-full z-0">
        <Header />
        <Marquee />
      </div>
      <div id="main_area" class="relative z-10 max-w-full lg:max-w-[500px] ml-auto lg:mr-[250px] bg-white">
        <main>
          <section id="news">
            <div class="mb-6">
              <h2 class="bg-gray-200 font-bold text-center py-2">お知らせ</h2>
              <div class="px-4 py-6">
                <ul class="mb-6 flex gap-x-4">
                  <li><a href="/news" data-cat="" class={selectedCategory === '' ? 'text-gray-900 font-bold' : 'underline text-gray-900'}>すべて</a></li>
                  {categories.map((cat) => (
                    <li><a href={`/news?category=${cat.id}`} data-cat={cat.id} class={selectedCategory === cat.id ? 'text-gray-900 font-bold' : 'underline text-gray-900'}>{cat.name}</a></li>
                  ))}
                </ul>
                <Newslist category={selectedCategory} categories={categories} />
              </div>
              <div class="text-center mt-8">
                <a href="/" class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">トップページに戻る</a>
              </div>
            </div>
          </section>
        </main>
        <Footer />
      </div>
    </div>
</Layout>
